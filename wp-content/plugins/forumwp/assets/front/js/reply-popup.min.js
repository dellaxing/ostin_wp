jQuery(document).ready(function(w){var r,t,i;w(document.body).on("click","#fmwp-reply-popup-preview-action",function(){var p=w(this).parents("#fmwp-reply-popup-editors");p.hasClass("fmwp-reply-popup-preview-hidden")?(p.removeClass("fmwp-reply-popup-preview-hidden"),w(this).html(w(this).data("hide_label")),w("#fmwpreplycontent-preview").html(w("#fmwpreplycontent").val())):(p.addClass("fmwp-reply-popup-preview-hidden"),w(this).html(w(this).data("show_label"))),fmwp_resize_popup()}),w(document.body).on("click",".fmwp-reply-popup-discard",function(){if(!fmwp_is_busy("reply_popup")){var e=w(this).parents("#fmwp-reply-popup-wrapper");e.hide(1,function(){e.find("form")[0].reset(),w("#fmwpreplycontent").val(""),w("#fmwpreplycontent-preview").html(""),e.removeClass("fmwp-fullsize");var p=e.find("#fmwp-reply-popup-preview-action");p.html(p.data("hide_label")),e.find("#fmwp-reply-popup-editors").removeClass("fmwp-reply-popup-preview-hidden"),e.trigger("fmwp_reply_popup_discard")})}}),w(document.body).on("click",".fmwp-reply-popup-submit",function(p){if(p.preventDefault(),!fmwp_is_busy("reply_popup")){var r=w(this);r.siblings(".fmwp-ajax-loading").css("visibility","visible").show(),r.css("visibility","hidden");var e=w(this).parents("form"),t=e.serializeArray(),i=(tinymce.get("fmwpreplycontent"),{});w.each(t,function(p){i[t[p].name]=t[p].value});var l=i["fmwp-reply[topic_id]"],s=i["fmwp-reply[reply_id]"],a="edit-reply"===i["fmwp-action"]?"fmwp_edit_reply":"fmwp_create_reply";e.find("input, #wp-fmwpreplycontent-wrap").removeClass("fmwp-error-field").removeAttr("title"),fmwp_set_busy("reply_popup",!0),wp.ajax.send(a,{data:i,success:function(p){"fmwp_edit_reply"==a?function(p,e,r){var t,i;if(0===p.post_parent)t=wp.template("fmwp-parent-reply"),p.sub_template=!1,i=t(p),w('.fmwp-topic-wrapper[data-fmwp_topic_id="'+e+'"]').find('.fmwp-reply-row[data-reply_id="'+r+'"]').replaceWith(i);else{t=wp.template("fmwp-parent-reply"),p.sub_template=!0,i=t(p);var l=w('.fmwp-topic-wrapper[data-fmwp_topic_id="'+e+'"]').find('.fmwp-reply-row[data-reply_id="'+p.post_parent+'"]').find("> .fmwp-reply-children");l.find('.fmwp-reply-row[data-reply_id="'+r+'"]').replaceWith(i)}fmwp_set_busy("reply_popup",!1),w(".fmwp-reply-popup-discard:first").trigger("click")}(p,l,s):function(p,e){var r,t,i,l;if(0===p.post_parent)r=wp.template("fmwp-parent-reply"),p.sub_template=!1,t=r(p),i=w('.fmwp-topic-wrapper[data-fmwp_topic_id="'+e+'"]'),"date_desc"===(l=i.data("order"))?i.prepend(t):"date_asc"===l&&i.append(t),i.find(".fmwp-topic-no-replies").length&&i.find(".fmwp-topic-no-replies").remove();else{r=wp.template("fmwp-parent-reply"),p.sub_template=!0,t=r(p),i=w('.fmwp-topic-wrapper[data-fmwp_topic_id="'+e+'"]'),l=i.data("order");var s=i.find('.fmwp-reply-row[data-reply_id="'+p.post_parent+'"]').find("> .fmwp-reply-children");if("date_desc"===l?s.prepend(t):"date_asc"===l&&s.append(t),p.is_subsub){s.siblings(".fmwp-reply-child-connect").show();var a=i.find('.fmwp-reply-row[data-reply_id="'+p.post_parent+'"]').closest(".fmwp-reply-row:not(.fmwp-child-reply)").find("> .fmwp-reply-base .fmwp-replies-count");a.html(parseInt(a.html())+1)}var n=i.find('.fmwp-reply-row[data-reply_id="'+p.post_parent+'"] > .fmwp-reply-base').find(".fmwp-replies-count");n.html(parseInt(n.html())+1);var o=wp.template("fmwp-subreplies-list"),f=o(p.parent_data);i.find('.fmwp-reply-row[data-reply_id="'+p.post_parent+'"] > .fmwp-reply-base').find(".fmwp-reply-left-panel").html(f)}fmwp_set_busy("reply_popup",!1),w(".fmwp-reply-popup-discard:first").trigger("click");var m=w("#fmwp-replies-total");m.html(parseInt(m.html())+1),fmwp_change_topic_sorting_visibility(i)}(p,l),fmwp_embed_resize_async(),r.siblings(".fmwp-ajax-loading").css("visibility","hidden"),r.css("visibility","visible")},error:function(e){e.errors?w.each(e.errors,function(p){jQuery("#"+e.errors[p].field).addClass("fmwp-error-field").attr("title",e.errors[p].message)}):(console.log(e),w(this).fmwp_notice({message:e,type:"error"})),fmwp_set_busy("reply_popup",!1),r.siblings(".fmwp-ajax-loading").css("visibility","hidden"),r.css("visibility","visible")}})}}),w(document.body).on("keyup","#fmwpreplycontent",(r=function(p){if(!w(this).parents("#fmwp-reply-popup-editors").hasClass("fmwp-reply-popup-preview-hidden")){if(fmwp_is_busy("reply_popup_preview"))return;var e=fmwp_stringToHash(this.value);if(e==w(this).data("content-hash"))return;w(this).data("content-hash",e),fmwp_set_busy("reply_popup_preview",!0),wp.ajax.send("fmwp_reply_build_preview",{data:{content:this.value,nonce:fmwp_front_data.nonce},success:function(p){w("#fmwpreplycontent-preview").is(":visible")?w("#fmwpreplycontent-preview").html(p):w("#fmwpreplycontent-preview").html(""),fmwp_set_busy("reply_popup_preview",!1)},error:function(p){console.log(p),w(this).fmwp_notice({message:p,type:"error"}),fmwp_set_busy("reply_popup_preview",!1)}})}},t=1e3,i=0,function(){var p=this,e=arguments;clearTimeout(i),i=setTimeout(function(){r.apply(p,e)},t||0)}))});