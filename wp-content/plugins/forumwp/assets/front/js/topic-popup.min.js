jQuery(document).ready(function(f){var i,e,o;f(document.body).on("click","#fmwp-topic-popup-preview-action",function(){var p=f(this).parents("#fmwp-topic-popup-editors");p.hasClass("fmwp-topic-popup-preview-hidden")?(p.removeClass("fmwp-topic-popup-preview-hidden"),f(this).html(f(this).data("hide_label")),f("#fmwptopiccontent-preview").html(f("#fmwptopiccontent").val())):(p.addClass("fmwp-topic-popup-preview-hidden"),f(this).html(f(this).data("show_label"))),fmwp_resize_popup()}),f(document.body).on("click",".fmwp-topic-popup-discard",function(){if(!fmwp_is_busy("topic_popup")){var t=f(this).parents("#fmwp-topic-popup-wrapper");t.hide(1,function(){t.find("form")[0].reset(),f("#fmwptopiccontent").val(""),f("#fmwptopiccontent-preview").html(""),t.removeClass("fmwp-fullsize");var p=t.find("#fmwp-topic-popup-preview-action");p.html(p.data("hide_label")),t.find("#fmwp-topic-popup-editors").removeClass("fmwp-topic-popup-preview-hidden")})}}),f(document.body).on("click",".fmwp-topic-popup-submit",function(p){if(p.preventDefault(),!fmwp_is_busy("topic_popup")){var i=f(this);i.siblings(".fmwp-ajax-loading").css("visibility","visible").show(),i.css("visibility","hidden");var e=f("#fmwp-topic-popup-wrapper"),t=f(this).parents("form"),o=t.serializeArray(),s={};f.each(o,function(p){s[o[p].name]=o[p].value});var a=s["fmwp-topic[forum_id]"],n=s["fmwp-topic[topic_id]"],c="edit-topic"===s["fmwp-action"]?"fmwp_edit_topic":"fmwp_create_topic";t.find("input, #wp-fmwptopiccontent-wrap").removeClass("fmwp-error-field").removeAttr("title"),fmwp_set_busy("topic_popup",!0),wp.ajax.send(c,{data:s,success:function(p){if("fmwp_edit_topic"==c){var t=e.data("fmwp-target");!function(p,t,i,e){if("forum-page"===e||"topics-page"===e){var o=wp.template("fmwp-topic"),s=o(p);f(".fmwp-topics-wrapper").find('.fmwp-topic-row[data-topic_id="'+i+'"]').replaceWith(s)}else if("topic-page"===e){if(f(".fmwp-topic-title").html(p.title),f(".fmwp-topic-data-content").html(p.content),f(".fmwp-topic-stats.fmwp-tags-stats").length){var a=wp.template("fmwp-topic-tags-line"),n=a(p.tags);f(".fmwp-topic-stats.fmwp-tags-stats").html(n)}wp.hooks.doAction("fmwp_after_edit_topic",p)}fmwp_set_busy("topic_popup",!1),f(".fmwp-topic-popup-discard:first").trigger("click")}(p,0,n,t)}else!function(p,t){var i=wp.template("fmwp-topic")(p),e=f('.fmwp-topics-wrapper[data-fmwp_forum_id="'+t+'"]');e.length||(e=f(".fmwp-archive-topics-wrapper .fmwp-topics-wrapper"));var o=e.data("order");"date_desc"===o?e.find(".fmwp-topic-row.fmwp-topic-announcement:last").length?e.find(".fmwp-topic-row.fmwp-topic-announcement:last").after(i):e.find(".fmwp-topic-row.fmwp-topic-pinned:last").length?e.find(".fmwp-topic-row.fmwp-topic-pinned:last").after(i):e.find(".fmwp-topic-row.fmwp-topic-global:last").length?e.find(".fmwp-topic-row.fmwp-topic-global:last").after(i):e.prepend(i):"date_asc"===o&&e.append(i);e.find(".fmwp-forum-no-topics").length&&e.find(".fmwp-forum-no-topics").remove();e.find(".fmwp-topic-actions-dropdown").length?e.siblings(".fmwp-topics-wrapper-heading").removeClass("fmwp-no-actions-heading"):e.siblings(".fmwp-topics-wrapper-heading").addClass("fmwp-no-actions-heading");fmwp_set_busy("topic_popup",!1),f(".fmwp-topic-popup-discard:first").trigger("click")}(p,a);i.siblings(".fmwp-ajax-loading").css("visibility","hidden"),i.css("visibility","visible")},error:function(t){t.errors?f.each(t.errors,function(p){jQuery("#"+t.errors[p].field).addClass("fmwp-error-field").attr("title",t.errors[p].message)}):(console.log(t),f(this).fmwp_notice({message:t,type:"error"})),fmwp_set_busy("topic_popup",!1),i.siblings(".fmwp-ajax-loading").css("visibility","hidden"),i.css("visibility","visible")}})}}),f(document.body).on("keyup","#fmwptopiccontent",(i=function(p){if(!f(this).parents("#fmwp-topic-popup-editors").hasClass("fmwp-topic-popup-preview-hidden")){if(fmwp_is_busy("topic_popup_preview"))return;var t=fmwp_stringToHash(this.value);if(t==f(this).data("content-hash"))return;f(this).data("content-hash",t),fmwp_set_busy("topic_popup_preview",!0),wp.ajax.send("fmwp_topic_build_preview",{data:{content:this.value,nonce:fmwp_front_data.nonce},success:function(p){f("#fmwptopiccontent-preview").html(p),fmwp_set_busy("topic_popup_preview",!1)},error:function(p){console.log(p),f(this).fmwp_notice({message:p,type:"error"}),fmwp_set_busy("topic_popup_preview",!1)}})}},e=1e3,o=0,function(){var p=this,t=arguments;clearTimeout(o),o=setTimeout(function(){i.apply(p,t)},e||0)}))});